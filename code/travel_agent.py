from textwrap import dedent
import os
import io
import base64
from pathlib import Path
from typing import List
from datetime import datetime

import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from pydantic import BaseModel, Field

from agno.agent.agent import Agent
from agno.models.groq.groq import Groq
from agno.tools.duckduckgo import DuckDuckGoTools
from agno.utils.log import logger

# ä¼˜åŒ–ï¼šæ•´ç†å¯¼å…¥è¯­å¥ï¼Œåˆ é™¤æœªä½¿ç”¨çš„åº“ï¼ŒæŒ‰ç…§æ ‡å‡†å®è·µè¿›è¡Œåˆ†ç»„

# å®šä¹‰Pydanticæ¨¡å‹
class DailyActivity(BaseModel):
    description: str = Field(
        ..., 
        description="The description of the activity for the day "
        "and includes the day number as prefix, e.g 'Day 1: Arrive'"
    )

class Itinerary(BaseModel):
    days: List[DailyActivity] = Field(
        ...,
        description="A list of activities for each day of the trip",
    )

# ä¿®æ”¹: æ›´æ–°Costæ¨¡å‹ä»¥åŒ¹é…APIè¿”å›çš„å­—æ®µåç§°
class Cost(BaseModel):
    totalcost: int = Field(
        ...,
        description="The overall cost of the trip, including all expenses."
    )
    accomodationcost: int = Field(
        ...,
        description="The cost of lodging during the trip, such as hotels or Airbnb rentals."
    )
    transportcost: int = Field(
        ...,
        description="The cost of transportation, including flights, trains, car rentals, or public transit."
    )
    ticketcost: int = Field(
        ...,
        description="The cost of tickets for attractions, tours, or events during the trip."
    )
    foodcost: int = Field(
        ...,
        description="The cost of meals and snacks during the trip"
    )

class Output(BaseModel):
    destination: str = Field(
        ...,
        description="The main destination of the trip."
    )
    duration: int = Field(
        ...,
        description="The number of days for the trip."
    )
    cost: Cost = Field(
        ...,
        description="The cost details of the trip."
    )
    itinerary: Itinerary = Field(
        ...,
        description="The detailed itinerary of the trip"
    )

# ä¿®æ”¹: æ›´æ–°é¥¼å›¾åˆ›å»ºå‡½æ•°ä»¥ä½¿ç”¨æ–°çš„å­—æ®µå
def create_pie_chart(cost_obj):
    """åˆ›å»ºå¹¶è¿”å›æˆæœ¬åˆ†å¸ƒé¥¼å›¾"""
    cost_pie_chart = [
        cost_obj.accomodationcost,
        cost_obj.transportcost,
        cost_obj.ticketcost,
        cost_obj.foodcost
    ]
    y = np.array(cost_pie_chart)
    labels = ["Accomodation", "Transport", "Ticket", "Food"]
    colors = ["#ff69b4", "#66b3ff", "#ffff99", "#ccccff"]
    
    fig, ax = plt.subplots()
    
    def absolute_value(val):
        a = np.round(val/100.*y.sum(), 0)
        return f'${int(a)}'
    
    ax.pie(y, labels=labels, autopct=absolute_value, startangle=90, colors=colors)
    ax.axis('equal')  # Equal aspect ratio ensures that pie is drawn as a circle.
    
    return fig

# ä¿®æ”¹: ç®€åŒ–save_markdownå‡½æ•°ï¼Œå»æ‰è¡¨æ ¼ï¼Œæ”¹è¿›æ ¼å¼
def save_markdown(destination, markdown_content, fig, cost_obj):
    """ä¿å­˜Markdownå†…å®¹å¹¶è¿”å›ä¸‹è½½æ–‡ä»¶ä¿¡æ¯ - ç®€åŒ–ç‰ˆï¼Œæ— è¡¨æ ¼"""
    # å°†å›¾è¡¨ä¿å­˜åˆ°ç¼“å†²åŒºç”¨äºmarkdownåµŒå…¥
    buf = io.BytesIO()
    fig.savefig(buf, format='png')
    data = base64.b64encode(buf.getbuffer()).decode("ascii")
    
    # é‡æ–°æ ¼å¼åŒ–markdownå†…å®¹ï¼Œç¡®ä¿ä¸€è‡´çš„æ ¼å¼
    formatted_content = f"""# AI Travel Planner: {destination} Itinerary

This itinerary was generated by an AI Travel Planner.

## Itinerary:

"""
    
    # æå–å¹¶æ·»åŠ æ¯å¤©çš„è¡Œç¨‹
    for line in markdown_content.split('\n'):
        if line.strip().startswith('Day '):
            formatted_content += f"{line.strip()}\n\n"
    
    # æ·»åŠ æˆæœ¬å›¾è¡¨ï¼ˆä¸æ·»åŠ è¡¨æ ¼ï¼‰
    formatted_content += f"""## Cost Breakdown:

![Cost Breakdown Pie Chart](data:image/png;base64,{data})
"""
    
    # ä¿å­˜åˆ°Markdownæ–‡ä»¶
    markdown_filename = f"{destination}_itinerary.md"
    with open(markdown_filename, "w", encoding="utf-8") as f:
        f.write(formatted_content)
    
    # å°è¯•ç”ŸæˆPDF
    download_file = markdown_filename
    try:
        # ä½¿ç”¨pandocå‚æ•°æ”¹è¿›æ ¼å¼
        cmd = (
            f"pandoc {markdown_filename} "
            f"--pdf-engine=xelatex "
            f"-V geometry:margin=1in "
            f"--standalone "
            f"-o {destination}_itinerary.pdf"
        )
        res = os.system(cmd)
        if res == 0 and os.path.exists(f"{destination}_itinerary.pdf"):
            download_file = f"{destination}_itinerary.pdf"
            # è¯»å–PDFæ–‡ä»¶ç”¨äºä¸‹è½½
            with open(download_file, "rb") as f:
                download_data = f.read()
        else:
            # PDFè½¬æ¢å¤±è´¥ï¼Œé€€å›åˆ°ä½¿ç”¨Markdown
            with open(markdown_filename, "rb") as f:
                download_data = f.read()
    except:
        # å‡ºç°å¼‚å¸¸æ—¶ï¼Œé€€å›åˆ°ä½¿ç”¨Markdown
        with open(markdown_filename, "rb") as f:
            download_data = f.read()
    
    return download_file, download_data

# ä¼˜åŒ–ï¼šå°†ä¸»ç¨‹åºé€»è¾‘å°è£…ä¸ºmainå‡½æ•°
def main():
    # è®¾ç½®Streamlitåº”ç”¨
    st.title("AI Travel Planner âœˆï¸")
    st.caption("Plan your next adventure with AI Travel Planner by researching and planning a personalized itinerary on autopilot using llama")

    # APIå¯†é’¥ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼‰
    groq_api_key = "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"

    # åˆ›å»ºä»£ç†
    researcher = Agent(
        name="TravelResearcher",
        role="Travel Information Gatherer",
        model=Groq(id="llama-3.3-70b-versatile", api_key=groq_api_key),
        description=dedent("Gather travel info using web search and provide a well-structured summary of findings."),
        instructions=[
            "1. Analyze Request: Understand destination, duration, group size, budget.",
            "2. Formulate Queries: Generate 3-5 focused search queries for relevant activities, potential hotels (considering budget/group size), typical costs (per person if possible), and specific locations/addresses.",
            "3. Execute Search: Use available tools to execute web searches for each query.",
            "4. Synthesize & Format Findings: Compile a clear summary of the most relevant findings. Structure the output text like this:",
            "   ```text",
            "   **Potential Activities:**",
            "   - [Activity Name 1]: [Brief Description]. Cost: [e.g., $50/person or $100 total or Free]. Location: [Specific Address or Area].",
            "   - [Activity Name 2]: [Brief Description]. Cost: [e.g., $XX]. Location: [Specific Address or Area].",
            "   ...(List 5-10 relevant activities found)...",
            "",
            "   **Hotel Suggestions:**",
            "   - [Hotel Name 1]: Approx. [Price /Night, e.g., $150]. Address: [Hotel Address]. Note: [Brief reasoning/feature found].",
            "   ...(List 1-3 relevant hotels found)...",
            "",
            "   **General Cost Notes:**",
            "   - Daily Food Estimate: ~$X per person.",
            "   - Local Transport Estimate: ~$Y per person per day.",
            "   ```",
            "5. Return Summary: Output *only* this structured text summary. Be informative but reasonably concise. Ensure costs and locations are included for each item.",
        ],
        tools=[DuckDuckGoTools()],
        add_datetime_to_instructions=True,
    )

    planner = Agent(
        name="ItineraryPlanner",
        role="Travel Itinerary Scheduler & Strict Formatter",
        model=Groq(id="llama-3.3-70b-versatile", api_key=groq_api_key),
        description=dedent("Create a detailed itinerary by scheduling activities from research, then strictly format the output according to the Pydantic model, ensuring clean data types and values (especially integer costs)."),
        instructions=[
            "1. Receive Input: User request (destination, days, people, budget) AND a structured text block summarizing research findings.",
            "2. Analyze & Select: Review user request and potential activities/hotels from research.",
            "3. Schedule Activities: Create a logical day-by-day itinerary for the specified duration, selecting activities from the research list. Ensure a balanced schedule.",
            "4. Determine Daily Details & Costs: For EACH scheduled day:",
            "   - Identify the main activities.",
            "   - Calculate the final estimated cost as a single **integer** value in USD for that day's scheduled activities (for the whole group). Resolve ranges/per-person costs. Store this single integer.",
            "   - Identify the most relevant specific address string.",
            "5. Select Hotel & Determine Price: Select ONE hotel from the research suggestions. Determine its estimated price per night as a single **integer** value (e.g., midpoint of range).",
            "6. Calculate Aggregate Costs: Based on the scheduled plan, the selected hotel (using the integer price from step 5), and daily cost notes: Calculate the *total* **integer** costs for `accommodation`, `transport`, `tickets`, and `food` for the entire trip. Sum these to get the overall `total_cost` **integer**.",
            "7. **CRITICAL FINAL FORMATTING STEP:** Before generating the final JSON output:",
            "   - Review ALL fields.",
            "   - Ensure ALL `Cost` fields (`totalcost`, `accomodationcost`, etc.) contain **only integer values** based on your step 6 calculations.",
            "   - Ensure EACH `DailyActivity.estimated_cost` contains **only the single integer value** calculated in step 4. **NO ranges, '$', '/person', text.**",
            "   - Ensure EACH `DailyActivity.address` contains a clean, specific address string or relevant area name.",
            "   - Ensure `HotelSuggestion.estimated_price_per_night` contains **only the single integer value** determined in step 5. **NO ranges, '$'.**",
            "   - Verify all other string fields contain only the intended text.",
            "8. Generate Output: Structure the *final, reviewed, and correctly formatted* data strictly according to the `Output` Pydantic model, ensuring all integer fields contain only numbers.",
            "9. Suggest Image Prompts: Generate 2-3 prompts based on the scheduled activities.",
        ],
        add_datetime_to_instructions=True,
        response_model=Output,
    )

    # è¾“å…¥å­—æ®µ
    destination = st.text_input("Where do you want to go?")
    # ä¼˜åŒ–ï¼šè®¾ç½®åˆç†çš„æœ€å°å€¼å’Œé»˜è®¤å€¼
    num_days = st.number_input("How many days do you want to travel for?", min_value=1, max_value=30, value=1)
    num_persons = st.number_input("How many persons for this trip?", min_value=1, value=1)
    total_budget = st.number_input("How much is the estimated travel expense (US dollar)?", min_value=0, value=0)

    if st.button("Generate Itinerary"):
        # ä¼˜åŒ–ï¼šæ·»åŠ è¾“å…¥éªŒè¯
        if not destination:
            st.error("Please enter a destination")
            return
            
        # ä¼˜åŒ–ï¼šåˆ†ç¦»ç ”ç©¶å’Œè§„åˆ’æ­¥éª¤ï¼Œåˆ†åˆ«æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        with st.spinner("Researching travel information..."):
            # è·å–ç ”ç©¶ä¿¡æ¯
            research_prompt = f"{destination} for {num_days} days for {num_persons} persons under {total_budget} US dollar"
            research_response = researcher.run(research_prompt, stream=False)
            st.subheader("Research Findings")
            st.write(research_response.content)
            
        with st.spinner("Creating your itinerary..."):
            # ç”Ÿæˆè¡Œç¨‹è®¡åˆ’
            planner_prompt = f"""
            **User Request:** Destination: {destination}, Duration: {num_days} days, People: {num_persons}, Budget: ~${total_budget} USD.

            **Research Findings (Potential Options):**
            ```text
            {research_response.content}
            ```
            """
            response = planner.run(planner_prompt, stream=False)
            
            if isinstance(response.content, Output):
                output_obj = response.content
                itinerary_obj = output_obj.itinerary
                cost_obj = output_obj.cost
                
                # åˆ›å»ºMarkdownå†…å®¹
                markdown_content = f"""
                # AI Travel Planner: {destination} Itinerary

                This itinerary was generated by an AI Travel Planner.

                ## Itinerary:
                """
                
                # ä¼˜åŒ–ï¼šæ”¹è¿›UIç»“æ„ï¼Œä½¿ç”¨å­æ ‡é¢˜æ˜ç¡®åˆ†éš”å†…å®¹
                st.subheader("Your Itinerary")
                for day in itinerary_obj.days:
                    st.write(day.description)
                    markdown_content += f"{day.description}\n\n"
                
                st.divider()
                
                # æ˜¾ç¤ºæˆæœ¬ç»†åˆ†
                st.header("Cost Breakdowns ğŸ’°")
                
                # ä¼˜åŒ–ï¼šä½¿ç”¨å°è£…çš„å‡½æ•°åˆ›å»ºé¥¼å›¾
                fig = create_pie_chart(cost_obj)
                st.pyplot(fig)
                
                # ä¿®æ”¹: æ›´æ–°æ€»æˆæœ¬æ˜¾ç¤ºä»¥ä½¿ç”¨æ–°å­—æ®µå
                st.subheader(f"Total Cost: {cost_obj.totalcost}US$")
                
                # ä¼˜åŒ–ï¼šä½¿ç”¨æ”¹è¿›çš„save_markdownå‡½æ•°å¹¶ä¼ é€’cost_objå‚æ•°
                download_file, download_data = save_markdown(destination, markdown_content, fig, cost_obj)
                
                # ä¼˜åŒ–ï¼šæ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®æ­£ç¡®çš„MIMEç±»å‹
                mime_type = "application/pdf" if download_file.endswith(".pdf") else "text/markdown"
                st.download_button(
                    label="Download Travel Plan",
                    data=download_data,
                    file_name=download_file,
                    mime=mime_type,
                )
            else:
                # ä¼˜åŒ–ï¼šæ·»åŠ é”™è¯¯å¤„ç†
                st.error("Failed to generate itinerary")

# ä¼˜åŒ–ï¼šä½¿ç”¨æ ‡å‡†çš„Pythonå…¥å£ç‚¹æ¨¡å¼
if __name__ == "__main__":
    main()